name: CI/CD Pipeline for Ju Keramia

on:
  push:
    branches:
      - main
      - '**'  # Trigger on all branches for auto-PR creation
  pull_request:
    branches: [main]

jobs:
  # Note: Linting is handled by separate lint.yaml workflow
  # This CI focuses on build, type-check, security, and ceramic-specific validations

  # TypeScript Type Checking
  type-check:
    runs-on: ubuntu-latest
    name: üîß TypeScript Type Checking

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìã Install Dependencies
        run: npm ci

      - name: üîß TypeScript Check
        run: npx nuxt typecheck

      - name: üìä Report Type Safety
        run: echo "‚úÖ TypeScript type checking passed!"

  # Build Test
  build:
    runs-on: ubuntu-latest
    name: üèóÔ∏è Build Application

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìã Install Dependencies
        run: npm ci

      - name: üèóÔ∏è Build Application
        run: npm run build
        env:
          # Provide test environment variables for build
          NUXT_RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 'test_key' }}
          NUXT_PUBLIC_HCAPTCHA_SITE_KEY: ${{ secrets.HCAPTCHA_SITE_KEY || 'test_site_key' }}
          NUXT_HCAPTCHA_SECRET_KEY: ${{ secrets.HCAPTCHA_SECRET_KEY || 'test_secret_key' }}

      - name: üìä Build Report
        run: echo "‚úÖ Application built successfully!"

  # Security Audit
  security-audit:
    runs-on: ubuntu-latest
    name: üîí Security Audit

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìã Install Dependencies
        run: npm ci

      - name: üîí Run Security Audit
        run: npm audit --audit-level=moderate

      - name: üìä Security Report
        run: echo "‚úÖ Security audit completed!"

  # Ceramic Design System Validation
  design-system-check:
    runs-on: ubuntu-latest
    name: üé® Ceramic Design System Validation

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìã Install Dependencies
        run: npm ci

      - name: üé® Validate Ceramic Design Tokens
        run: |
          echo "üîç Checking ceramic design system consistency..."

          # Check if ceramic CSS variables are properly defined
          if grep -q "color-clay-" app/assets/css/main.css; then
            echo "‚úÖ Clay color tokens found"
          else
            echo "‚ùå Clay color tokens missing" && exit 1
          fi

          if grep -q "color-sage-" app/assets/css/main.css; then
            echo "‚úÖ Sage color tokens found"
          else
            echo "‚ùå Sage color tokens missing" && exit 1
          fi

          if grep -q "spacing-ceramic-" app/assets/css/main.css; then
            echo "‚úÖ Ceramic spacing tokens found"
          else
            echo "‚ùå Ceramic spacing tokens missing" && exit 1
          fi

          echo "‚úÖ Ceramic design system validation passed!"

  # Contact Form Validation Test
  contact-form-test:
    runs-on: ubuntu-latest
    name: üìß Contact Form Validation

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: üìã Install Dependencies
        run: npm ci

      - name: üìß Validate Contact Form Security
        run: |
          echo "üîç Checking contact form security implementation..."

          # Check if form validation is implemented (supports both manual and Nuxt UI patterns)
          if grep -q ':schema="schema"' app/pages/contact/index.vue || grep -q "schema.parse(form.value)" app/pages/contact/index.vue; then
            echo "‚úÖ Form validation implementation found"
          else
            echo "‚ùå Form validation missing - security risk!" && exit 1
          fi

          # Check if validation schema is imported (either directly or via composable)
          if grep -q "useContactFormValidation" app/pages/contact/index.vue || grep -q "contactFormSchema" app/pages/contact/index.vue; then
            echo "‚úÖ Validation schema/composable imported"
          else
            echo "‚ùå Validation schema not imported" && exit 1
          fi

          # Check if hCaptcha integration exists
          if grep -q "initializeCaptcha" app/pages/contact/index.vue || grep -q "useCaptcha" app/pages/contact/index.vue || grep -q "h-captcha-container" app/pages/contact/index.vue; then
            echo "‚úÖ hCaptcha integration found"
          else
            echo "‚ùå hCaptcha integration missing" && exit 1
          fi

          echo "‚úÖ Contact form security validation passed!"

  # Sync to Owner Repository (triggers Vercel deployment) test test again
  sync-to-owner:
    runs-on: ubuntu-latest
    name: üöÄ Sync to Owner Repository
    needs: [type-check, build, security-audit, design-system-check, contact-form-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper sync

      - name: üîê Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: üöÄ Push to Owner Repository
        env:
          OWNER_REPO_TOKEN: ${{ secrets.OWNER_REPO_TOKEN }}
        run: |
          # Add owner remote if it doesn't exist
          if ! git remote | grep -q "owner"; then
            git remote add owner https://x-access-token:${OWNER_REPO_TOKEN}@github.com/jukeramia/ju_keramia.git
          fi

          # Push to owner repository (triggers Vercel deployment)
          git push owner main --force-with-lease

          echo "‚úÖ Successfully synced to owner repository!"
          echo "üöÄ Vercel deployment should trigger automatically"

  # Final Status Check
  all-checks-passed:
    runs-on: ubuntu-latest
    name: ‚úÖ All Quality Checks
    needs: [type-check, build, security-audit, design-system-check, contact-form-test]
    if: always()

    steps:
      - name: üéâ Success Report
        run: |
          echo "üè∫ ====================================="
          echo "üéâ All Ju Keramia quality checks passed!"
          echo "‚ÑπÔ∏è  Code linting handled by lint.yaml"
          echo "‚úÖ TypeScript type safety"
          echo "‚úÖ Application build"
          echo "‚úÖ Security audit"
          echo "‚úÖ Ceramic design system"
          echo "‚úÖ Contact form security"
          echo "üè∫ Ready for ceramic perfection! ‚ú®"
          echo "====================================="

  # Auto Create Pull Request for Feature Branches
  auto-create-pr:
    runs-on: ubuntu-latest
    name: üîÑ Auto Create Pull Request
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Check if PR Already Exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $BRANCH_NAME"

          PR_EXISTS=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number')

          if [ -n "$PR_EXISTS" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_EXISTS" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è PR #$PR_EXISTS already exists for branch $BRANCH_NAME"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "‚ú® No existing PR found - will create new one"
          fi

      - name: üéâ Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")

          if [[ "$COMMIT_MSG" =~ ^(update|fix|feat|chore|docs): ]]; then
            PR_TITLE="$COMMIT_MSG"
          else
            PR_TITLE=$(echo "$BRANCH_NAME" | sed 's/[-_]/ /g' | sed 's/\b\(.\)/\u\1/g' | sed 's/^feature\///i' | sed 's/^fix\///i' | sed 's/^feat\///i')
          fi

          PR_BODY="## üè∫ Changes Summary

          This pull request was automatically created when changes were pushed to \`$BRANCH_NAME\`.

          ### üìã Latest Commit
          \`\`\`
          $COMMIT_MSG
          \`\`\`

          ### ‚úÖ Checklist
          - [ ] Code follows ceramic design system guidelines
          - [ ] All tests pass
          - [ ] TypeScript type checks pass
          - [ ] No security vulnerabilities introduced
          - [ ] Documentation updated if needed

          ---
          *Auto-generated by GitHub Actions*"

          gh pr create \
            --title "üè∫ $PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME"

          echo "‚úÖ Pull request created successfully!"

      - name: ‚ÑπÔ∏è PR Already Exists
        if: steps.check-pr.outputs.pr_exists == 'true'
        run: |
          echo "‚ÑπÔ∏è Pull request #${{ steps.check-pr.outputs.pr_number }} already exists for this branch"
          echo "View it at: ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.check-pr.outputs.pr_number }}"
