name: CI/CD Pipeline for Ju Keramia

on:
  push:
    branches: [main, 'feature/**', 'feat/**', 'fix/**', 'hotfix/**']
  pull_request:
    branches: [main]

jobs:
  # Note: Linting is handled by separate lint.yaml workflow
  # This CI focuses on build, type-check, security, and ceramic-specific validations

  # TypeScript Type Checking
  type-check:
    runs-on: ubuntu-latest
    name: ğŸ”§ TypeScript Type Checking

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ”§ TypeScript Check
        run: npx nuxt typecheck

      - name: ğŸ“Š Report Type Safety
        run: echo "âœ… TypeScript type checking passed!"

  # Build Test
  build:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build Application

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ—ï¸ Build Application
        run: npm run build
        env:
          # Provide test environment variables for build
          NUXT_RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 'test_key' }}
          NUXT_PUBLIC_HCAPTCHA_SITE_KEY: ${{ secrets.HCAPTCHA_SITE_KEY || 'test_site_key' }}
          NUXT_HCAPTCHA_SECRET_KEY: ${{ secrets.HCAPTCHA_SECRET_KEY || 'test_secret_key' }}

      - name: ğŸ“Š Build Report
        run: echo "âœ… Application built successfully!"

  # Security Audit
  security-audit:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Audit

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ”’ Run Security Audit
        run: npm audit --audit-level=moderate

      - name: ğŸ“Š Security Report
        run: echo "âœ… Security audit completed!"

  # Ceramic Design System Validation
  design-system-check:
    runs-on: ubuntu-latest
    name: ğŸ¨ Ceramic Design System Validation

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ¨ Validate Ceramic Design Tokens
        run: |
          echo "ğŸ” Checking ceramic design system consistency..."

          # Check if ceramic CSS variables are properly defined
          if grep -q "color-clay-" app/assets/css/main.css; then
            echo "âœ… Clay color tokens found"
          else
            echo "âŒ Clay color tokens missing" && exit 1
          fi

          if grep -q "color-sage-" app/assets/css/main.css; then
            echo "âœ… Sage color tokens found"
          else
            echo "âŒ Sage color tokens missing" && exit 1
          fi

          if grep -q "spacing-ceramic-" app/assets/css/main.css; then
            echo "âœ… Ceramic spacing tokens found"
          else
            echo "âŒ Ceramic spacing tokens missing" && exit 1
          fi

          echo "âœ… Ceramic design system validation passed!"

  # Contact Form Validation Test
  contact-form-test:
    runs-on: ubuntu-latest
    name: ğŸ“§ Contact Form Validation

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“‹ Install Dependencies
        run: npm ci

      - name: ğŸ“§ Validate Contact Form Security
        run: |
          echo "ğŸ” Checking contact form security implementation..."

          # Check if form validation is implemented (supports both manual and Nuxt UI patterns)
          if grep -q ':schema="schema"' app/pages/contact/index.vue || grep -q "schema.parse(form.value)" app/pages/contact/index.vue; then
            echo "âœ… Form validation implementation found"
          else
            echo "âŒ Form validation missing - security risk!" && exit 1
          fi

          # Check if validation schema is imported (either directly or via composable)
          if grep -q "useContactFormValidation" app/pages/contact/index.vue || grep -q "contactFormSchema" app/pages/contact/index.vue; then
            echo "âœ… Validation schema/composable imported"
          else
            echo "âŒ Validation schema not imported" && exit 1
          fi

          # Check if hCaptcha integration exists
          if grep -q "initializeCaptcha" app/pages/contact/index.vue || grep -q "useCaptcha" app/pages/contact/index.vue || grep -q "h-captcha-container" app/pages/contact/index.vue; then
            echo "âœ… hCaptcha integration found"
          else
            echo "âŒ hCaptcha integration missing" && exit 1
          fi

          echo "âœ… Contact form security validation passed!"

  # Sync to Owner Repository (triggers Vercel deployment)
  sync-to-owner:
    runs-on: ubuntu-latest
    name: ğŸš€ Sync to Owner Repository
    needs: [type-check, build, security-audit, design-system-check, contact-form-test]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper sync

      - name: ğŸ” Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: ğŸ”‘ Setup SSH Key
        env:
          SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: ğŸš€ Push to Owner Repository
        run: |
          # Add owner remote with SSH
          if ! git remote | grep -q "owner"; then
            git remote add owner git@github.com:jukeramia/ju_keramia.git
          fi

          # Configure git to use SSH key
          export GIT_SSH_COMMAND="ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes"

          # Push to owner repository (triggers Vercel deployment)
          git push owner main --force

          echo "âœ… Successfully synced to owner repository!"
          echo "ğŸš€ Vercel deployment should trigger automatically"

  # Create Pull Request from Feature Branch to Main
  create-pr-to-main:
    runs-on: ubuntu-latest
    name: ğŸ”€ Create PR to Main
    needs: [type-check, build, security-audit, design-system-check, contact-form-test]
    if: github.ref != 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”€ Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get branch name
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Get latest commit info
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_SHA=$(git log -1 --pretty=format:"%h")

          # Create PR title and body
          PR_TITLE="${COMMIT_MESSAGE}"
          PR_BODY="## ğŸ”„ Feature Branch Ready for Review

          **Branch:** \`${BRANCH_NAME}\`
          **Latest Commit:** ${COMMIT_SHA}
          **Author:** ${COMMIT_AUTHOR}

          ### âœ… Quality Checks Passed
          - âœ… TypeScript type checking
          - âœ… Application build
          - âœ… Security audit
          - âœ… Ceramic design system validation
          - âœ… Contact form security

          This PR is automatically created when changes are pushed to a feature branch.

          **Ready for review and merge!**"

          # Create PR using GitHub CLI
          gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            || echo "PR already exists or unable to create"

      - name: ğŸ“Š PR Creation Report
        run: echo "âœ… Pull request created to main branch!"

  # Final Status Check
  all-checks-passed:
    runs-on: ubuntu-latest
    name: âœ… All Quality Checks
    needs: [type-check, build, security-audit, design-system-check, contact-form-test]
    if: always()

    steps:
      - name: ğŸ‰ Success Report
        run: |
          echo "ğŸº ====================================="
          echo "ğŸ‰ All Ju Keramia quality checks passed!"
          echo "â„¹ï¸  Code linting handled by lint.yaml"
          echo "âœ… TypeScript type safety"
          echo "âœ… Application build"
          echo "âœ… Security audit"
          echo "âœ… Ceramic design system"
          echo "âœ… Contact form security"
          echo "ğŸº Ready for ceramic perfection! âœ¨"
          echo "====================================="
